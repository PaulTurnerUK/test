<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie PWA</title>
    <meta name="theme-color" content="#4f46e5">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <style>
        #offline-indicator {
            display: none;
        }
        #offline-indicator.visible {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center">
    <div id="offline-indicator" class="bg-red-600 text-white px-4 py-2 rounded mb-4">You are offline. Requests will sync when online.</div>
    <div class="w-full max-w-md bg-white rounded-xl shadow p-6 flex flex-col items-center">
        <h1 class="text-2xl font-bold mb-4">Movie Search</h1>
        <form id="movie-form" class="w-full flex flex-col gap-4 items-center">
            <input type="text" id="movie-input" placeholder="Enter a movie title..." required class="w-full bg-gray-100 border-0 rounded px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none text-gray-800 placeholder-gray-400">
            <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded font-medium hover:bg-indigo-700 transition">Search Movie</button>
        </form>
        <div id="movie-result" class="w-full mt-8 hidden flex-col items-center bg-gray-50 rounded-xl shadow p-6 text-center"></div>
    </div>
    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js');
            });
        }

        // UI Elements
        const form = document.getElementById('movie-form');
        const input = document.getElementById('movie-input');
        const result = document.getElementById('movie-result');
        const offlineIndicator = document.getElementById('offline-indicator');

        // Movie mock DB
        const mockMovies = {
            'inception': {
                title: 'Inception',
                year: 2010,
                director: 'Christopher Nolan',
                plot: 'A thief who steals corporate secrets through dream-sharing technology is given the inverse task of planting an idea.',
                thumbnail: 'https://m.media-amazon.com/images/I/51v5ZpFyaFL._AC_SY679_.jpg'
            },
            'interstellar': {
                title: 'Interstellar',
                year: 2014,
                director: 'Christopher Nolan',
                plot: 'A team of explorers travel through a wormhole in space in an attempt to ensure humanityâ€™s survival.',
                thumbnail: 'https://m.media-amazon.com/images/I/91kFYg4fX3L._AC_SY679_.jpg'
            },
            'matrix': {
                title: 'The Matrix',
                year: 1999,
                director: 'The Wachowskis',
                plot: 'A computer hacker learns about the true nature of his reality and his role in the war against its controllers.',
                thumbnail: 'https://m.media-amazon.com/images/I/51EG732BV3L.jpg'
            }
        };

        // IndexedDB helpers for queue
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('movie-queue', 1);
                request.onupgradeneeded = function(e) {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('queue')) {
                        db.createObjectStore('queue', { autoIncrement: true });
                    }
                };
                request.onsuccess = function(e) { resolve(e.target.result); };
                request.onerror = function(e) { reject(e.target.error); };
            });
        }
        async function addToQueue(title) {
            const db = await openDB();
            const tx = db.transaction('queue', 'readwrite');
            tx.objectStore('queue').add({ title });
            return tx.complete;
        }
        async function getAllQueued() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('queue', 'readonly');
                const store = tx.objectStore('queue');
                const req = store.getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }
        async function clearQueue() {
            const db = await openDB();
            const tx = db.transaction('queue', 'readwrite');
            tx.objectStore('queue').clear();
            return tx.complete;
        }

        // Show movie details
        function showMovie(details) {
            result.innerHTML = `
                <img src="${details.thumbnail}" alt="${details.title}" class="w-32 h-48 object-cover rounded-lg mx-auto mb-4 shadow">
                <h2 class="text-xl font-bold mb-2">${details.title} <span class="text-gray-400 text-base">(${details.year})</span></h2>
                <p class="text-sm text-gray-600 mb-1"><strong>Director:</strong> ${details.director}</p>
                <p class="text-sm text-gray-700 mb-3">${details.plot}</p>
            `;
            result.classList.remove('hidden');
        }

        // Online/offline UI
        function updateOnlineStatus() {
            if (navigator.onLine) {
                offlineIndicator.classList.remove('visible');
            } else {
                offlineIndicator.classList.add('visible');
            }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // Form submit
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const title = input.value.trim();
            if (!title) return;
            if (navigator.onLine) {
                // Online: show immediately
                const details = mockMovies[title.toLowerCase()] || {
                    title,
                    year: 2025,
                    director: 'Unknown',
                    plot: 'No details found. This is a made-up movie.',
                    thumbnail: 'https://cdn-icons-png.flaticon.com/512/744/744922.png'
                };
                showMovie(details);
            } else {
                // Offline: queue
                await addToQueue(title);
                result.innerHTML = `<div class='text-yellow-600 font-medium'>You are offline. Movie request queued for sync.</div>`;
                result.classList.remove('hidden');
            }
            input.value = '';
        });

        // Register background sync when back online
        async function registerSync() {
            if ('serviceWorker' in navigator && 'SyncManager' in window) {
                const reg = await navigator.serviceWorker.ready;
                try {
                    await reg.sync.register('sync-movie-queue');
                } catch (e) {
                    // Ignore errors
                }
            }
        }
        window.addEventListener('online', registerSync);

        // Listen for sync event from SW
        navigator.serviceWorker && navigator.serviceWorker.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'movie-result') {
                showMovie(event.data.details);
            }
        });
    </script>
</body>
</html>
